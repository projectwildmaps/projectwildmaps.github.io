<!DOCTYPE html>
<html>

<head>
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<title>PMAPS: PWILD Marking/Annotating Pisgah Systematically</title>
	<link rel="shortcut icon" href="favicon.ico" />
	<link type="text/css" rel="stylesheet" href="style.css"/>


	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDfSBibzyTDahkTrbF19v4Ch9sP_96gb-U"></script>
	<script type="text/javascript" src="https://www.google.com/jsapi"></script>
	<script type="text/javascript">
		google.load('visualization', '1', { packages: ["map", "table"] });
	</script>
</head>

<body>
	<!--Content of the input form, gets moved from here into the input form info window
		the first time the user opens the form. Doing it this way instead of a content string
		so that we can use addEventListener for the submit button-->
	<div id="input_form_content">
		<label for='name'>Your Name: </label><br>
		<input type='text' id='name' class='input_field' />

		<label for='markerDescription'>Marker Description:</label><br>
		<textarea id='markerDescription' class='input_field' style="height: 100px; width: 260px;"></textarea>

		<label for='categories'>Category:</label><br>
		<input list='category' id='categories' class='input_field'>
		<datalist id='category'></datalist> <!--populated in init()-->

		<input id='submit' type='button' value='Save & Close' />
	</div>


	<div id="map"></div>
	<div id="legend">
		<b>Legend</b>
	</div>

	<div id="instructions_container">
		<div id="instructions">
			<div id="instruction_scroll_content">
				Hoka Hey!
				<p>Welcome to PMAPS, blah blah blah</p>
			</div>
			<button id="close_instructions" onclick="document.getElementById('instructions_container').style.display='none'">
				Let's Go!
			</button>
		</div>
	</div>

	
	<script>
		// GLOBALS (ones we should keep track of at least)
		var map;
		var markers = {}; //object to store our marker features, format "database_key": Feature object
		var markerLayer; //global because legend.js needs to see this
		var trailLayer;
		var inputInfoWindow; //global because saveData() needs this
		var usersMarker; //global because saveData() needs this
		var archived_visible = false; //legend.js and archive button use this
		var categories = ['VAM (View Appreciation Moment)',
							'Waterfall',
							'Water',
							'Safety',
							'Campsite',
							'Pro-Tip!',
							'Landmark',
							'Funny Story',
							'Solos',
							'Other' //default, doesn't get special treatment in getDot()
						];
	</script>

	<script src="detect_mobile.js"></script>
	<script src="map_definitions.js"></script>
	<script src="getDot.js"></script>
	<script src="legend.js"></script>
	<script src="autopan.js"></script>
	<script src="trails.js"></script>

	<!--STUFF INVOLVING THE DATABASE-->

	 <!--Firebase is module-based, so need a module script tag. Note that firebase imports are
		only active in this script tag, so put all the database code here. Also note that js
		treats module scripts as their own scope, so nothing declared here is in the global scope.-->
	<script type="module">
		//SET UP FIREBASE DATABASE ---------------------------------------------------

		// Import the functions you need from the SDKs you need
		import { initializeApp } from "https://www.gstatic.com/firebasejs/9.14.0/firebase-app.js";
		import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/9.14.0/firebase-app-check.js"
		import { getDatabase, ref, onChildAdded, onChildChanged, onChildRemoved, update, push } from "https://www.gstatic.com/firebasejs/9.14.0/firebase-database.js";
		
		// Your web app's Firebase configuration
		// For Firebase JS SDK v7.20.0 and later, measurementId is optional
		const firebaseConfig = {
			apiKey: "AIzaSyBB0sKq5KVASNFDmL9mxk2ZNXIcAevAwy8",
			authDomain: "pmaps-9b073.firebaseapp.com",
			projectId: "pmaps-9b073",
			storageBucket: "pmaps-9b073.appspot.com",
			messagingSenderId: "359127963683",
			appId: "1:359127963683:web:0dd617799d832f5b77f996",
			measurementId: "G-JKPFPGX204"
		};

		// Initialize Firebase
		const app = initializeApp(firebaseConfig);
		const database = getDatabase(app);
		const appCheck = initializeAppCheck(app, {
  			provider: new ReCaptchaV3Provider('6Lc-dTUjAAAAAOQFOlQaN6w81vK1Eso4oflV1sZk'),
			isTokenAutoRefreshEnabled: true
		});

		// END OF FIREBASE SETUP ------------------------------------------------------

		

		window.addEventListener("load", init);
		function init() {
			var opts = {
				streetViewControl: true,
				mapTypeId: 'Nat Geo',
				backgroundColor: "rgb(220,220,220)",
				center: new google.maps.LatLng(35.292621, -82.833716),
				zoom: 13,
				mapTypeControlOptions: {
					mapTypeIds: [
						'USGS 2013', 'USGS TIFF', 'Nat Geo', 'USGS',
						google.maps.MapTypeId.ROADMAP, google.maps.MapTypeId.SATELLITE,
						google.maps.MapTypeId.HYBRID, google.maps.MapTypeId.TERRAIN
					]
				}
			}
			map = new google.maps.Map(document.getElementById("map"), opts);
			map.setTilt(45);

			// add maps defined in map_definitions.js to the map
			//map.mapTypes.set('USGS 2013', usgs2013);
			map.mapTypes.set('USGS TIFF', usgsTiff);
			map.mapTypes.set('Nat Geo', natGeo);
			//map.mapTypes.set('USGS', usgsStolen);

			initLegend(); //legend.js

			// Things above this point deal with the maps. Things below this point deals with the data.

			/*
				var trailDataLayer = new google.maps.Data();
				trailDataLayer.loadGeoJson('trails/srw_data.geojson');
				trailDataLayer.loadGeoJson('trails/graveyard.geojson');
				trailDataLayer.loadGeoJson('trails/davidson.geojson');
				trailDataLayer.loadGeoJson('trails/blueRidge.geojson');
				trailDataLayer.loadGeoJson('trails/blackBalsam.geojson');
				trailDataLayer.loadGeoJson('trails/mills.geojson');
				trailDataLayer.loadGeoJson('trails/farlow.geojson');
				trailDataLayer.loadGeoJson('trails/mount2sea.geojson');
			
				trailDataLayer.addListener('click', function(event) {
					var content = "<div class='googft-info-window'>"+
									"<h1>"+event.feature.getProperty('name')+"</h1>"+
									"<i>"+event.feature.getProperty('segment')+"</i>"+
									"</div>";
					infowindow.setContent(content);
					infowindow.setPosition(event.feature.getGeometry().get()); //This doesn't work. This would be right if it were points, not trails.
					infowindow.open(map);
				});
				trailDataLayer.setMap(map);
			*/

			// Create data layer to hold all the data people have added
			markerLayer = new google.maps.Data();

			// Add everything in the firebase database to the data layer and markers reference object
			// This callback triggers once for each point, and then again for new points added
			onChildAdded(ref(database), (snapshot => {
				let data = snapshot.val()
				var geowanted = new google.maps.Data.Point({ lat: data.lat, lng: data.lon });
				var propswanted = {
					name: data.name,
					description: data.description,
					category: data.category,
					date: data.date,
					archived: data.archived,
					archived_visible: archived_visible, //styling attribute
					my_category_visible: true, //styling attribute, set to true even if category not visible, so users have confirmation their new point was created successfully
					ref: snapshot.ref //database reference object
				};
				var new_feature = new google.maps.Data.Feature({ geometry: geowanted, properties: propswanted });
				markers[snapshot.key] = new_feature; //markers is a global variable
				markerLayer.add(new_feature);
			}));
			// Handle points being modified (archive/unarchive, comments)
			onChildChanged(ref(database), (snapshot => {
				markers[snapshot.key].setProperty('archived', snapshot.val().archived); //triggers style recompute
			}));
			// Handle points being removed. This will only happen if someone deletes a point from the firebase console.
			// We're not allowing clients to delete points, only archive them.
			onChildRemoved(ref(database), (snapshot => {
				console.log("Removing: ", snapshot.val());
				markerLayer.remove(markers[snapshot.key]);
				delete markers[snapshot.key];
			}));


			// Color the data layer based on the category of the data, and give each point roll over text
			markerLayer.setStyle(function (feature) {
				let visible = feature.getProperty('my_category_visible');
				if (feature.getProperty('archived') && !feature.getProperty('archived_visible')) {
					visible = false;
				}
				return {
					icon: getDot(feature.getProperty('category')),
					title: feature.getProperty('description'),
					visible: visible
				};
			});

			// When the data layer is clicked on, display the appropriate data
			window.dataInfoWindow = new google.maps.InfoWindow({disableAutoPan: true});
			window.dataInfoWindow = dataInfoWindow
			markerLayer.addListener('click', function (event) {
				var timeStamp = event.feature.getProperty('date');
				var category = event.feature.getProperty('category');
				var markerDescription = event.feature.getProperty('description');
				var contributorName = event.feature.getProperty('name');
				var archived = event.feature.getProperty('archived');
				var ref = event.feature.getProperty('ref');

				var content = document.createElement("div");
				content.innerHTML = (category? "<b>" + category + "</b>" : "") +
									"<div class='info_window_actions'>" +
										"<u class='add_comment'>Add Comment</u>" +
										"<u class='set_archived'>" + (archived ? "Unarchive" : "Archive") +"</u>" +
									"</div>" +
									"<p>" + markerDescription + "</p>" +
									"Contributed By: " + contributorName + "<br>" +
									"<i>" + timeStamp + "</i><br>"
				
				content.addEventListener("click", function(e){
					if(e.target.classList.contains("set_archived")){
						archived = !archived;
						update(ref, {'archived': archived});
						content.querySelector(".set_archived").textContent = archived ? "Unarchive" : "Archive";
					}
					else if(e.target.classList.contains("add_comment")){
						console.log("comment");
					}
				});

				dataInfoWindow.setContent(content);
				dataInfoWindow.setPosition(event.feature.getGeometry().get());
				dataInfoWindow.open(map);
				
				//auto pan (timeout is to wait for the element to be displayed so we can get bounding boxes)
				window.setTimeout(function(){
					autoPan(content)
				}, 10);
			});

			// Put the data layer on the map
			markerLayer.setMap(map);

			// Make an info window for showing the data input form. Global so other funcs can see it
			var category_datalist = document.getElementById("category");
			categories.forEach((category) => {
				let option = document.createElement("option");
				option.value = category;
				category_datalist.appendChild(option);
			});
			inputInfoWindow = new google.maps.InfoWindow({disableAutoPan: true});
			inputInfoWindow.setContent(document.getElementById("input_form_content")); //beginning of body tag
			document.getElementById("submit").addEventListener("click", saveData);
			//if mobile device, squish size of input fields to better fit
			if(isMobileBrowser()){ //detect_mobile.js
				document.querySelectorAll(".input_field").forEach((el) => {
					el.style.width = "200px";
				})
			}

			// Makes a big red pin, used for inputting data
			usersMarker = new google.maps.Marker({
				position: map.getCenter(),
				map: map,
				title: 'Use me to mark places',
				draggable: true,
				animation: google.maps.Animation.DROP,
				anchorPoint: new google.maps.Point(0, -30)
			});
			// When the user clicks on the big red pin, open up the form for data input.
			google.maps.event.addListener(usersMarker, 'click', function(){
				inputInfoWindow.open(map, usersMarker);

				//auto pan (timeout is to wait for the element to be displayed so we can get bounding boxes)
				setTimeout(function(){
					autoPan(document.getElementById("input_form_content"))
				}, 10);
				
				//reset fields (have to do it after opening, in order to access the elements)
				document.getElementById("name").value = "";
				document.getElementById("markerDescription").value = "";
				document.getElementById("categories").value = "";
			});
			// When the user moves the big red pin, close the data input form. They clearly don't need it. You know what? We don't need them either!
			google.maps.event.addListener(usersMarker, 'position_changed', function () { inputInfoWindow.close(); });


			// Trails Stuff
			/*trailLayer = new google.maps.FusionTablesLayer({
				query: {
					select: 'ns1:coordinates',
					from: '1Rk-HToZ45a3mpLbWfBf9sY_5cmaVP0ibBFVk_GA',
					where: 'id3 > 1'
				},
				map: null,
				suppressInfoWindows: true,
				styles: [{
					polylineOptions: {
						strokeWeight: 1
					}
				}]
			});
			google.maps.event.addListener(trailLayer, 'click', function (e) {
				windowControlTrail(e, infoWindow, map);
			});
			var trailControlDiv = document.createElement('div');
			var trailControl = new TrailControl(trailControlDiv, map);
			trailControlDiv.index = 1;
			map.controls[google.maps.ControlPosition.TOP_RIGHT].push(trailControlDiv);
			*/
		}
		function saveData() { //What to do when the user hits the "submit" button on the user input form.
			// Awkwardly pulls what the user wrote on the input form
			var name = document.getElementById("name").value;
			var description = document.getElementById("markerDescription").value;
			var category = document.getElementById("categories").value;
			
			if(description.length == 0){
				alert("Please input a description.");
				return;
			}

			if(name.length == 0){
				let confirmed = confirm("You haven't provided a name, do you wish to remain anonymous?");
				if(!confirmed) return;
				name = "Unknown";
			}

			if(category.length == 0){
				let confirmed = confirm("You haven't provided a category, are you sure you want to leave this field blank? It will default to 'Other' as the category.")
				if (!confirmed) return;
				category = "Other";
			}

			var pos = usersMarker.getPosition();
			var d = new Date();
			var dateString = (d.getMonth() + 1) + "-" + d.getDate() + "-" + d.getFullYear();

			// Adds the data to the database
			push(ref(database), {
				lat: pos.lat(),
				lon: pos.lng(),
				name: name,
				description: description,
				category: category,
				date: dateString,
				archived: false
			});

			inputInfoWindow.close(); // If we're saving data, we must be done with the input form, so let's close it.
		}
	</script>
</body>

</html>