<!DOCTYPE html>
<html>

<head>
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<title>PMAPS: PWILD Marking/Annotating Pisgah Systematically</title>
	<link rel="shortcut icon" href="favicon.ico" />
	<link type="text/css" rel="stylesheet" href="style.css"/>


	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDfSBibzyTDahkTrbF19v4Ch9sP_96gb-U"></script>
	<script type="text/javascript" src="https://www.google.com/jsapi"></script>
	<script type="text/javascript">
		google.load('visualization', '1', { packages: ["map", "table"] });
	</script>
</head>

<body>
	<!--Content of the input form, gets moved from here into the input form info window
		the first time the user opens the form. Doing it this way instead of a content string
		so that we can use addEventListener for the submit button-->
	<div id="input_form_content">
		<label for='name'>Your Name: </label><br>
		<input type='text' id='name' class='input_field' />

		<label for='markerDescription'>Marker Description:</label><br>
		<textarea id='markerDescription' class='input_field' style="height: 100px; width: 260px;"></textarea>

		<label for='categories'>Category:</label><br>
		<input list='category' id='categories' class='input_field'>
		<datalist id='category'></datalist> <!--populated in init()-->

		<input id='submit' type='button' value='Save & Close' />
	</div>


	<div id="map"></div>
	<div id="legend">
		<b>Legend</b>
	</div>
	<div id="footer">Some of these maps generated with <a href="http://www.maptiler.com/">MapTiler</a></div>

	<div id="instructions_container">
		<div id="instructions">
			<div id="instruction_scroll_content">
				Hoka Hey!
				<p>Welcome to PMAPS, blah blah blah</p>
			</div>
			<button id="close_instructions" onclick="document.getElementById('instructions_container').style.display='none'">
				Let's Go!
			</button>
		</div>
	</div>

	
	<script>
		// GLOBALS (ones we should keep track of at least)
		var map;
		var markerLayer;
		var trailLayer;
		var inputInfoWindow;
		var usersMarker;
		var categories = ['VAM (View Appreciation Moment)',
							'Waterfall',
							'Water',
							'Safety',
							'Campsite',
							'Pro-Tip!',
							'Landmark',
							'Funny Story',
							'Solos',
							'Other' //default, doesn't get special treatment in getDot()
						];
	</script>

	<script src="detect_mobile.js"></script>
	<script src="map_definitions.js"></script>
	<script>
		function getDot(category) // Given the category of a data point, spits out the appropriate color of the data point
		{
			if (category == "Waterfall") //purple
				return "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAJCAYAAADgkQYQAAAAi0lEQVR42mNgQIAoIF4NxGegdCCSHAMzEC+NMov6vzp99f8zVWfAdKBh4H+g+EyYorQ027T//2f+x8CxFrEghbEgRQcOFB/Aqmhv4V6Qor0gRQ8ftj/Equh2822QottEmxQLshubohCjEJCiEJjj54N8tzFrI9h36zLWwXw3jQENgMJpIzSc1iGHEwBt95qDejjnKAAAAABJRU5ErkJggg==";
			else if (category == "Water") //blue
				return "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAJCAYAAADgkQYQAAAAiklEQVR42mNgQIAoIF4NxGegdCCSHAMzEC81M4v6n56++n9V1RkwbWgY+B8oPhOmKM3WNu3/zJn/MbCFRSxIYSxI0YHi4gNYFRUW7gUp2gtS9LC9/SFWRc3Nt0GKbhNtUizIbmyKjIxCQIpCYI6fD/JdVtZGsO8yMtbBfDeNAQ2AwmkjNJzWIYcTAMk+i9OhipcQAAAAAElFTkSuQmCC";
			else if (category == "Safety") //yellow
				return "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAJCAYAAADgkQYQAAAAi0lEQVR42mNgQIAoIF4NxGegdCCSHAMzEC+NijL7v3p1+v8zZ6rAdGCg4X+g+EyYorS0NNv////PxMCxsRYghbEgRQcOHCjGqmjv3kKQor0gRQ8fPmzHquj27WaQottEmxQLshubopAQI5CiEJjj54N8t3FjFth369ZlwHw3jQENgMJpIzSc1iGHEwB8p5qDBbsHtAAAAABJRU5ErkJggg==";
			else if (category == "Campsite")  //green
				return "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAJCAYAAADgkQYQAAAAiElEQVR42mNgQIAoIF4NxGegdCCSHAMzEC81izL7n746/X/VmSowbRho+B8oPhOmKM02zfb/TCzQItYCpDAWpOhA8YFirIoK9xaCFO0FKXrY/rAdq6Lm280gRbeJNikWZDc2RUYhRiBFITDHzwf5LmtjFth3GesyYL6bxoAGQOG0ERpO65DDCQDX7ovT++K9KQAAAABJRU5ErkJggg==";
			else if (category == "Pro-Tip!") //red
				return "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAJCAYAAADgkQYQAAAAiklEQVR42mNgQIAoIF4NxGegdCCSHAMzEC+NUlH5v9rF5f+ZoCAwHaig8B8oPhOmKC1NU/P//7Q0DByrqgpSGAtSdOCAry9WRXt9fECK9oIUPXwYFYVV0e2ICJCi20SbFAuyG5uiECUlkKIQmOPng3y30d0d7Lt1bm4w301jQAOgcNoIDad1yOEEAFm9fSv/VqtJAAAAAElFTkSuQmCC";
			else if (category == "Landmark") //darkgreen+
				return "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAJCAYAAADgkQYQAAAArUlEQVR42mNggAIBJYZCUU2Go8KqDLdBtKAKQyYDEmAW1WI4aBvM9d86meW/bSormLYO4vwvpsOwA6yCT56h2jGE+79lGtN/41QGOAbx7YAa+RUZShiE1Riu2KSwQCTTkDCQDxIXVme4yCCozPDKDmgFNkUgcSFlhmfEmQSyE2Q3NjfZBHP+B/oyG+x4MW2GPWDfpUB9lwL33XbkYACHk4gGw0lQOIloMhxHDicA77heAmO53v0AAAAASUVORK5CYII=";
			else if (category == "Funny Story") //darkpurple+
				return "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAJCAYAAADgkQYQAAAAq0lEQVR42mNggAIlBqVCTQbNo6oMqrdBtAqDSiYDEmDWYtA6mMQV/D+LJfl/LmsqmE7gDPqvw6CzA6xCnkG+Oo075H8WU9r/NIZUOAbxk4EaFRkUSxjUGNSu5LCkQCXTkHDq/2yguDqD+kUGZQblV3msqVgVgcSB8s+IMwlkJ8hubG5K4Az+D/RlNtjx2gzae0C+A+mE+C4F5rvtyMEADicNBo2T0HA6jhxOAIFkaCWva8LfAAAAAElFTkSuQmCC";
			else if (category == "Solos")//brown+
				return "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAJCAYAAADgkQYQAAAAiklEQVR42mNgQIAoIF4NxGegdCCSHAMzEC+NslL5v7rU+f+Z3iAwHWii8B8oPhOmKC3NSfP//01pGDjWRhWkMBak6MCBVl+sivY2+4AU7QUpevhwThRWRbdnRIAU3SbapFiQ3dgUhZgpgRSFwBw/H+S7jVVuYN+tq3CD+W4aAxoAhdNGaDitQw4nAFZ+h+ARB/VOAAAAAElFTkSuQmCC";
			else if (category == "VAM (View Appreciation Moment)") //light blue
				return "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAJCAYAAADgkQYQAAAAl0lEQVR42mNgQIAoIF4NxGegdCCSHAMzEC91sLH9H9c34X/hqjVg2tLM/D9QfCZMUZqni+v/+odP/2d/+QnHIL6TnT1IYSxI0YHM+YvAEmk//8ExiJ8xdwFI0V6Qooc1u/dhVVS5bSdI0W2iTYoF2Y3NTTYWliBFITDHzwf5LmnyVLDvEiZOhvluGgMaAIXTRmg4rUMOJwARmo9axahWIwAAAABJRU5ErkJggg==";
			else //darkgrey+
				//the "Other" category will map here along with any random category a user typed in (or undefined)
				return "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAJCAYAAADgkQYQAAAAgElEQVR42mNggAJFRcUWdXX16yoqKs9AtJKSUh0DEmDW0NC44mhr+9/e3h6OHW1s/mtqap4Dq5CXl+91QlMAVwgUV1BQaGdQVVV9iE0BDKupqd1nUFZW/uCARxFQ/i1xJoHsdMTjJqAvG8COB/ruAg7fnUUOBlg43YSG0w3kcAIAxcVqHwlKq6YAAAAASUVORK5CYII=";
		}
	</script>
	<script src="legend.js"></script>
	<script src="autopan.js"></script>

	<!--STUFF INVOLVING THE DATABASE-->

	 <!--Firebase is module-based, so need a module script tag. Note that firebase imports are
		only active in this script tag, so put all the code here. Also note that js treates module
		scripts as their own scope, so nothing declared here is in the global scope.-->
	<script type="module">
		//SET UP FIREBASE DATABASE ---------------------------------------------------

		// Import the functions you need from the SDKs you need
		import { initializeApp } from "https://www.gstatic.com/firebasejs/9.14.0/firebase-app.js";
		import { getDatabase, ref, onValue, push } from "https://www.gstatic.com/firebasejs/9.14.0/firebase-database.js";
		//import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.14.0/firebase-analytics.js";

		// TODO: Add SDKs for Firebase products that you want to use
		// https://firebase.google.com/docs/web/setup#available-libraries

		// Your web app's Firebase configuration
		// For Firebase JS SDK v7.20.0 and later, measurementId is optional
		const firebaseConfig = {
			apiKey: "AIzaSyBB0sKq5KVASNFDmL9mxk2ZNXIcAevAwy8",
			authDomain: "pmaps-9b073.firebaseapp.com",
			projectId: "pmaps-9b073",
			storageBucket: "pmaps-9b073.appspot.com",
			messagingSenderId: "359127963683",
			appId: "1:359127963683:web:0dd617799d832f5b77f996",
			measurementId: "G-JKPFPGX204"
		};

		// Initialize Firebase
		const app = initializeApp(firebaseConfig);
		const database = getDatabase(app);
		//const analytics = getAnalytics(app);

		// END OF FIREBASE SETUP ------------------------------------------------------

		

		window.addEventListener("load", init);
		function init() {
			var opts = {
				streetViewControl: true,
				mapTypeId: 'Nat Geo',
				backgroundColor: "rgb(220,220,220)",
				center: new google.maps.LatLng(35.292621, -82.833716),
				zoom: 13,
				mapTypeControlOptions: {
					mapTypeIds: [
						'USGS 2013', 'USGS TIFF', 'Nat Geo', 'USGS',
						google.maps.MapTypeId.ROADMAP, google.maps.MapTypeId.SATELLITE,
						google.maps.MapTypeId.HYBRID, google.maps.MapTypeId.TERRAIN
					]
				}
			}
			map = new google.maps.Map(document.getElementById("map"), opts);
			map.setTilt(45);

			// add maps defined in map_definitions.js to the map
			//map.mapTypes.set('USGS 2013', usgs2013);
			map.mapTypes.set('USGS TIFF', usgsTiff);
			map.mapTypes.set('Nat Geo', natGeo);
			//map.mapTypes.set('USGS', usgsStolen);

			initLegend(); //legend.js

			// Things above this point deal with the maps. Things below this point deals with the data.

			/*
				var trailDataLayer = new google.maps.Data();
				trailDataLayer.loadGeoJson('trails/srw_data.geojson');
				trailDataLayer.loadGeoJson('trails/graveyard.geojson');
				trailDataLayer.loadGeoJson('trails/davidson.geojson');
				trailDataLayer.loadGeoJson('trails/blueRidge.geojson');
				trailDataLayer.loadGeoJson('trails/blackBalsam.geojson');
				trailDataLayer.loadGeoJson('trails/mills.geojson');
				trailDataLayer.loadGeoJson('trails/farlow.geojson');
				trailDataLayer.loadGeoJson('trails/mount2sea.geojson');
			
				trailDataLayer.addListener('click', function(event) {
					var content = "<div class='googft-info-window'>"+
									"<h1>"+event.feature.getProperty('name')+"</h1>"+
									"<i>"+event.feature.getProperty('segment')+"</i>"+
									"</div>";
					infowindow.setContent(content);
					infowindow.setPosition(event.feature.getGeometry().get()); //This doesn't work. This would be right if it were points, not trails.
					infowindow.open(map);
				});
				trailDataLayer.setMap(map);
			*/

			// Create data layer to hold all the data people have added
			markerLayer = new google.maps.Data();

			// Add everything in the firebase database to the data layer and markers reference object
			onValue(ref(database), (snapshot => {
				let data = snapshot.val()
				for (let key in data) {
					var geowanted = new google.maps.Data.Point({ lat: data[key].lat, lng: data[key].lon });
					var propswanted = {
						name: data[key].name,
						description: data[key].description,
						category: data[key].category,
						date: data[key].date
					};
					markerLayer.add({ geometry: geowanted, properties: propswanted });
				}
			}));

			// Color the data layer based on the category of the data, and give each point roll over text
			markerLayer.setStyle(function (feature) {
				return ({
					icon: getDot(feature.getProperty('category')),
					title: feature.getProperty('description')
				});
			});

			// When the data layer is clicked on, display the appropriate data
			window.dataInfoWindow = new google.maps.InfoWindow({disableAutoPan: true});
			window.dataInfoWindow = dataInfoWindow
			markerLayer.addListener('click', function (event) {
				var timeStamp = event.feature.getProperty('date');
				var category = event.feature.getProperty('category');
				var markerDescription = event.feature.getProperty('description');
				var contributorName = event.feature.getProperty('name');

				var content = "<div id='data_info_div'>" +
					(category? "<b>" + category + "</b>" : "") +
					"<p>" + markerDescription + "</p>" +
					"Contributed By: " + contributorName + "<br>" +
					"<i>" + timeStamp + "</i><br></div>";

				dataInfoWindow.setContent(content);
				dataInfoWindow.setPosition(event.feature.getGeometry().get());
				dataInfoWindow.open(map);
				
				//auto pan (timeout is to wait for the element to be displayed so we can get bounding boxes)
				window.setTimeout(function(){
					autoPan(document.getElementById("data_info_div"))
				}, 10);
			});

			// Put the data layer on the map
			markerLayer.setMap(map);

			// Make an info window for showing the data input form. Global so other funcs can see it
			var category_datalist = document.getElementById("category");
			categories.forEach((category) => {
				let option = document.createElement("option");
				option.value = category;
				category_datalist.appendChild(option);
			});
			inputInfoWindow = new google.maps.InfoWindow({disableAutoPan: true});
			inputInfoWindow.setContent(document.getElementById("input_form_content")); //beginning of body tag
			document.getElementById("submit").addEventListener("click", saveData);
			//if mobile device, squish size of input fields to better fit
			if(isMobileBrowser()){ //detect_mobile.js
				document.querySelectorAll(".input_field").forEach((el) => {
					el.style.width = "200px";
				})
			}

			// Makes a big red pin, used for inputting data
			usersMarker = new google.maps.Marker({
				position: map.getCenter(),
				map: map,
				title: 'Use me to mark places',
				draggable: true,
				animation: google.maps.Animation.DROP,
				anchorPoint: new google.maps.Point(0, -30)
			});
			// When the user clicks on the big red pin, open up the form for data input.
			google.maps.event.addListener(usersMarker, 'click', function(){
				inputInfoWindow.open(map, usersMarker);

				//auto pan (timeout is to wait for the element to be displayed so we can get bounding boxes)
				setTimeout(function(){
					autoPan(document.getElementById("input_form_content"))
				}, 10);
				
				//reset fields (have to do it after opening, in order to access the elements)
				document.getElementById("name").value = "";
				document.getElementById("markerDescription").value = "";
				document.getElementById("categories").value = "";
			});
			// When the user moves the big red pin, close the data input form. They clearly don't need it. You know what? We don't need them either!
			google.maps.event.addListener(usersMarker, 'position_changed', function () { inputInfoWindow.close(); });


			// Trails Stuff
			/*trailLayer = new google.maps.FusionTablesLayer({
				query: {
					select: 'ns1:coordinates',
					from: '1Rk-HToZ45a3mpLbWfBf9sY_5cmaVP0ibBFVk_GA',
					where: 'id3 > 1'
				},
				map: null,
				suppressInfoWindows: true,
				styles: [{
					polylineOptions: {
						strokeWeight: 1
					}
				}]
			});
			google.maps.event.addListener(trailLayer, 'click', function (e) {
				windowControlTrail(e, infoWindow, map);
			});
			var trailControlDiv = document.createElement('div');
			var trailControl = new TrailControl(trailControlDiv, map);
			trailControlDiv.index = 1;
			map.controls[google.maps.ControlPosition.TOP_RIGHT].push(trailControlDiv);
			*/
		}
		function saveData() { //What to do when the user hits the "submit" button on the user input form.
			// Awkwardly pulls what the user wrote on the input form
			var name = document.getElementById("name").value;
			name = name.length == 0 ? "Unknown" : name;
			console.log(name, name.length)
			var description = document.getElementById("markerDescription").value;
			var cat = document.getElementById("categories").value;

			if(description.length == 0){
				alert("Please input a description.");
				return;
			}

			var pos = usersMarker.getPosition();
			var d = new Date();
			var dateString = (d.getMonth() + 1) + "-" + d.getDate() + "-" + d.getFullYear();

			// Adds the data to the database
			push(ref(database), {
				lat: pos.lat(),
				lon: pos.lng(),
				name: name,
				description: description,
				category: cat,
				date: dateString
			});

			inputInfoWindow.close(); // If we're saving data, we must be done with the input form, so let's close it.
		}
		
		function windowControlTrail(e, infoWindow, map) {
			e.infoWindowHtml = "<div class='googft-info-window'>" +
				"<h1>" + e.row['ns3:name'].value + "</h1>" +
				"<i>" + e.row['ns3:segment'].value + "</i>" +
				"<p>" + e.row['Description'].value + "</p>" +
				"<b>Overall Difficulty:</b> " + e.row['Overall Difficulty'].value + "<br>" +
				"<b>Length:</b> " + e.row['Length'].value + "<br>" +
				"<b>Steepness:</b> " + e.row['Steepness'].value + "<br>" +
				"<b>Trail/Tread Condition:</b> " + e.row['Trail/Tread Condition'].value + "<br>" +
				"<b>Blaze Color:</b> " + e.row['Blaze Color'].value + "<br>" +
				"<b>USGS/USFS Number:</b> " + e.row['USGS/USFS Number'].value + "<br>" +
				"<b>Allowed Uses:</b> " + e.row['Allowed Uses'].value + "<br>" +
				"<b>Hikes That Use This Trail:</b> " + e.row['Hikes That Use This Trail'].value + "<br>" +
				"</div>";
			infoWindow.setOptions({
				content: e.infoWindowHtml,
				position: e.latLng,
				pixelOffset: e.pixelOffset
			});
			infoWindow.open(map);
		}
		function TrailControl(controlDiv, map) { //Pertains to the button that controls whether or not to show trails

			// Set CSS styles for the DIV containing the control
			// Setting padding to 5 px will offset the control
			// from the edge of the map
			controlDiv.style.padding = '5px';

			// Set CSS for the control border
			var controlUI = document.createElement('div');
			controlUI.style.backgroundColor = 'white';
			controlUI.style.borderStyle = 'solid';
			controlUI.style.borderWidth = '2px';
			controlUI.style.cursor = 'pointer';
			controlUI.style.textAlign = 'center';
			controlUI.title = 'Click to show/hide the trails';
			controlDiv.appendChild(controlUI);

			// Set CSS for the control interior
			var controlText = document.createElement('div');
			controlText.style.fontFamily = 'Arial,sans-serif';
			controlText.style.fontSize = '12px';
			controlText.style.paddingLeft = '4px';
			controlText.style.paddingRight = '4px';
			controlText.innerHTML = '<b>Trails</b>';
			controlUI.appendChild(controlText);

			// Setup the click event listeners
			google.maps.event.addDomListener(controlUI, 'click', toggleTrails);

		}
		function toggleTrails() // This is to turn on and off the trails when the trails button is clicked
		{
			if (trailLayer.getMap() === map)
				hideTrails();
			else
				showTrails();
		}
		function hideTrails() // This turns off the display of the trails. This function is called when toggleTrails happens.
		{
			trailLayer.setMap(null);
		}
		function showTrails() // This turns on the display of the trails. This function is called when toggleTrails happens.
		{
			trailLayer.setMap(map);
		}
	</script>
</body>

</html>